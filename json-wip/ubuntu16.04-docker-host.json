{
   "variables": {
      "ssh_name": "ubuntu",
      "ssh_pass": "ubuntu",
      "hostname": "packer-test"
   },

  "builders": [
     {
         "type"     : "amazon-ebs",
         "region"   : "us-east-1",

         "source_ami_filter": {
           "filters": {
             "virtualization-type": "hvm",
             "name": "*ubuntu-xenial-16.04-amd64-server-*",
             "root-device-type": "ebs"
           },
           "owners": ["099720109477"],
           "most_recent": true
         },
         "instance_type": "t2.micro",
         "ssh_username": "ubuntu",
         "ami_name": "ubuntu.16.04.1.server.docker-host",
         "force_deregister": true
     },
     {
        "type": "virtualbox-iso",
        "boot_command" : [
           "<enter><f6><esc>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs><bs><bs>",
           "<bs><bs><bs>",
           "auto preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg ",
           "debian-installer=en_CA locale=en_CA kbd-chooser/method=us ",
           "hostname=rails-5 ",
           "fb=false debconf/frontend=noninteractive ",
           "keyboard-configuration/modelcode=SKIP keyboard-configuration/layout=USA ",
           "keyboard-configuration/variant=USA console-setup/ask_detect=false ",
           "vga=788 initrd=/install/initrd.gz quiet --- ",
           "<enter>"
        ],
     "boot_wait": "4s",
     "guest_os_type": "Ubuntu_64",
     "http_directory": "http",
     "iso_checksum": "d2d939ca0e65816790375f6826e4032f",
     "iso_checksum_type": "md5",
     "iso_url": "http://releases.ubuntu.com/16.04/ubuntu-16.04.1-server-amd64.iso",
     "ssh_username": "vagrant",
     "ssh_password": "vagrant",
     "ssh_wait_timeout": "10000s",
     "disk_size": "8000",
     "shutdown_command": "echo 'vagrant' | sudo -S shutdown -P now",
     "vboxmanage": [
         [
           "modifyvm",
           "{{.Name}}",
           "--memory",
           "512"
         ],
         [
           "modifyvm",
           "{{.Name}}",
           "--cpus",
           "1"
         ],
         [
           "guestproperty",
           "set",
           "{{.Name}}",
           "--timesync-set-on-restore",
           "1"
         ]
       ]
     }],
  "provisioners": [{
        "type"   : "shell",
        "inline" : [
           "sleep 30",
           "sudo mkdir ~vagrant/.ssh",
           "sudo chmod 700 ~vagrant/.ssh",
           "sudo wget --no-check-certificate 'https://raw.githubusercontent.com/larsonj/public-keys/master/vagrant.pub' -O ~vagrant/.ssh/authorized_keys",
           "sudo chmod 600 ~vagrant/.ssh/authorized_keys",
           "sudo chown -R vagrant:vagrant ~vagrant/.ssh"
        ],
        "only"   : ["virtualbox-iso"]
     },
     {
        "type":"shell",
        "inline":["sleep 10"]
     },
     {
     "type": "shell",
     "inline": [
        "sleep 10",
        "sudo apt-get update",
        "sudo apt-get install -y apt-transport-https ca-certificates nfs-common",
        "sudo apt-key adv --keyserver hkp://ha.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D",
        "echo 'deb https://apt.dockerproject.org/repo ubuntu-xenial main' | sudo tee /etc/apt/sources.list.d/docker.list",
        "sudo apt-get update",
        "sudo apt-get install -y docker-engine",
        "sudo usermod -aG docker ubuntu",
        "sudo apt-get install -y watch"
    ]
  }]
},
  "post-processors": [
    {   
        "type": "vagrant",
        "only": ["virtualbox-iso"],
        "output": "ubuntu16.04.1-dockerhost.box",
        "vagrantfile_template": "Vagrantfile-template"
    }   
  ]

